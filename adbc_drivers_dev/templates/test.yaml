<% if private %>
# Copyright (c) 2025 Columnar Technologies Inc.  All rights reserved.
<% else %>
# Copyright (c) 2025 ADBC Drivers Contributors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
<% endif %>

# !!!! AUTO-GENERATED FILE.  DO NOT EDIT. !!!!
# USE adbc-gen-workflow (see adbc-drivers/dev) TO UPDATE THIS FILE.

# This is a common workflow for building & testing drivers:
#
# - Build the driver
# - Start dependencies
# - Run tests
# - Build the shared library

name: <{lang_human}> <{workflow_name}>

on:
<% if not release %>
  pull_request:
    branches:
      - main
    paths:
      - "<{lang_subdir}>/**"
<% for path in pull_request_trigger_paths %>
      - <{path}>
<% endfor %>
<% endif %>
  push:
<% if release %>
    tags:
      - "<{lang_subdir}>/v**"
<% else %>
    branches:
      - main
    paths:
      - "<{lang_subdir}>/**"
<% for path in pull_request_trigger_paths %>
      - <{path}>
<% endfor %>
<% endif %>

<% if not release and secrets["all"] %>
  workflow_call:
    inputs:
      repository:
        description: "The repository to checkout (in owner/repo short format)"
        required: true
        type: string
      ref:
        description: "The ref to checkout"
        required: true
        type: string
    secrets:
<% for name, val in secrets["all"].items() %>
      <{val}>:
        required: true
<% endfor %>
<% endif %>
<% if release %>
  workflow_dispatch: {}
<% endif %>

concurrency:
<% if environment %>
  # Must share concurrency group with release workflow since it also builds/tests
  group: ${{ github.repository }}-${{ github.ref }}-<{environment}>
<% else %>
  group: ${{ github.repository }}-${{ github.ref }}-${{ github.workflow }}
<% endif %>
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  test:
    name: "Test/${{ matrix.platform }}_${{ matrix.arch }}"
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: true
      matrix:
        include:
          - { platform: linux, arch: amd64, runner: ubuntu-latest }
          - { platform: macos, arch: arm64, runner: macos-latest }
          - { platform: windows, arch: amd64, runner: windows-latest }
<% if environment %>
    environment: <{environment}>
<% endif %>
    permissions:
      contents: read
<% if permissions.get("id_token") %>
      id-token: write
<% endif %>
    steps:
      - name: free up disk space
        if: runner.os != 'Windows'
        run: |
          # Preinstalled tools use a lot of disk space, free up some space
          # https://github.com/actions/runner-images/issues/2840
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"

<% if release or not secrets["all"] %>
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false
<% else %>
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        if: github.event_name != 'workflow_dispatch'
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: "checkout remote"
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        if: github.event_name == 'workflow_dispatch'
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.ref }}
          fetch-depth: 0
          persist-credentials: false
<% endif %>

<% if lang == "go" %>
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5  # v6.2.0
        with:
          cache-dependency-path: go/go.sum
          check-latest: true
          go-version-file: go/go.mod
<% elif lang == "rust" %>
      - uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c  # v1.15.2
        with:
          components: "clippy"
<% endif %>

      - uses: prefix-dev/setup-pixi@82d477f15f3a381dbcc8adc1206ce643fe110fb7  # v0.9.3
        with:
          pixi-version: v0.63.2
          run-install: false

<% if aws %>
      - name: AWS Login
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708  # v5.1.1
        with:
          aws-region: <{aws.region}>
          role-to-assume: ${{ secrets.aws_role }}
          role-session-name: ${{ secrets.aws_role_session_name }}
<% endif %>
<% if gcloud %>
      - name: Google Cloud Login
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093  # v3.0.0
        with:
          service_account: ${{ secrets.gcloud_service_account }}
          workload_identity_provider: ${{ secrets.gcloud_workload_identity_provider }}
<% endif %>

      - name: Build
<% if secrets["build:test"] %>
        env:
<% for name, val in secrets["build:test"].items() %>
          <{name}>: ${{ secrets.<{val}> }}
<% endfor %>
<% endif %>
        working-directory: <{ lang_subdir }>
        run: |
          if [[ -f ci/scripts/pre-build.sh ]]; then
            echo "Loading pre-build"
            ./ci/scripts/pre-build.sh test ${{ matrix.platform }} ${{ matrix.arch }}
          fi

<% if lang == "go" %>
          go build ./...
<% elif lang == "rust" %>
          cargo build --locked
<% else %>
<{not_implemented(lang)}>
<% endif %>

      - name: Start Test Dependencies
        # Can't use Docker on macOS AArch64 runners, and Windows containers
        # work but often the container doesn't support Windows
        if: runner.os == 'Linux'
        working-directory: <{ lang_subdir }>
        run: |
          if [[ -f compose.yaml ]]; then
            if ! docker compose up --detach --wait test-service; then
              echo "Service failed to start"
              echo "Logs:"
              docker compose logs test-service
              exit 1
            fi
          fi

      - name: Test
<% if secrets["test"] %>
        env:
<% for name, val in secrets["test"].items() %>
          <{name}>: ${{ secrets.<{val}> }}
<% endfor %>
<% endif %>
        working-directory: <{ lang_subdir }>
        run: |
          set -a
          if [[ -f .env ]]; then
            source .env
          fi
          if [[ -f .env.${{ matrix.platform }} ]]; then
            source .env.${{ matrix.platform }}
          fi
          if [[ -f .env.ci ]]; then
            source .env.ci
          fi
          set +a

          if [[ -f ci/scripts/pre-test.sh ]]; then
            echo "Loading pre-test"
            ./ci/scripts/pre-test.sh ${{ matrix.platform }} ${{ matrix.arch }}
          fi

<% if lang == "go" %>
          go test -tags assert -v ./...
<% elif lang == "rust" %>
          cargo test
<% else %>
<{not_implemented(lang)}>
<% endif %>

          if [[ -f ci/scripts/post-test.sh ]]; then
            ./ci/scripts/post-test.sh
          fi

<% if lang == "go" %>
      - name: go mod tidy
        if: runner.os == 'Linux'
        working-directory: <{ lang_subdir }>
        run: |
          go mod tidy --diff
<% endif %>

<% if not lang_config.skip_validate %>
  validate:
    name: "Validate/${{ matrix.platform }}_${{ matrix.arch }}"
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: true
      matrix:
        include:
          # I think we only need to test one platform, but we can change that later
          - { platform: linux, arch: amd64, runner: ubuntu-latest }
<% if environment %>
    environment: <{environment}>
<% endif %>
    permissions:
      contents: read
<% if permissions.get("id_token") %>
      id-token: write
<% endif %>
    steps:
      - name: free up disk space
        if: runner.os != 'Windows'
        run: |
          # Preinstalled tools use a lot of disk space, free up some space
          # https://github.com/actions/runner-images/issues/2840
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"

<% if release or not secrets["all"] %>
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false
<% else %>
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        if: github.event_name != 'workflow_dispatch'
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: "checkout remote"
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        if: github.event_name == 'workflow_dispatch'
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.ref }}
          fetch-depth: 0
          persist-credentials: false
<% endif %>

<% if lang == "go" %>
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5  # v6.2.0
        with:
          cache-dependency-path: go/go.sum
          check-latest: true
          go-version-file: go/go.mod
<% elif lang == "rust" %>
      - uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c  # v1.15.2
        with:
          components: "clippy"
<% endif %>

      - uses: prefix-dev/setup-pixi@82d477f15f3a381dbcc8adc1206ce643fe110fb7  # v0.9.3
        with:
          pixi-version: v0.63.2
          run-install: false

<% if aws %>
      - name: AWS Login
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708  # v5.1.1
        with:
          aws-region: <{aws.region}>
          role-to-assume: ${{ secrets.aws_role }}
          role-session-name: ${{ secrets.aws_role_session_name }}
<% endif %>
<% if gcloud %>
      - name: Google Cloud Login
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093  # v3.0.0
        with:
          service_account: ${{ secrets.gcloud_service_account }}
          workload_identity_provider: ${{ secrets.gcloud_workload_identity_provider }}
<% endif %>

      - name: Log in to ghcr.io
        if: runner.os == 'Linux'
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build Library
<% if secrets["build:test"] %>
        env:
<% for name, val in secrets["build:test"].items() %>
          <{name}>: ${{ secrets.<{val}> }}
<% endfor %>
<% endif %>
        working-directory: <{ lang_subdir }>
        run: |
          if [[ -f ci/scripts/pre-build.sh ]]; then
            ./ci/scripts/pre-build.sh test ${{ matrix.platform }} ${{ matrix.arch }}
          fi
          set -a
          if [[ -f .env.release ]]; then
            source .env.test
          fi
          set +a
          pixi run adbc-make build DEBUG=true VERBOSE=true DRIVER=<{driver}> IMPL_LANG=<{lang}> <{' '.join(lang_config.build.additional_make_args) }>

      - name: Start Test Dependencies
        # Can't use Docker on macOS AArch64 runners, and Windows containers
        # work but often the container doesn't support Windows
        if: runner.os == 'Linux'
        working-directory: <{ lang_subdir }>
        run: |
          if [[ -f compose.yaml ]]; then
            if ! docker compose up --detach --wait test-service; then
              echo "Service failed to start"
              echo "Logs:"
              docker compose logs test-service
              exit 1
            fi
          fi

      - name: Validate
        if: runner.os == 'Linux'
<% if secrets["validate"] %>
        env:
<% for name, val in secrets["validate"].items() %>
          <{name}>: ${{ secrets.<{val}> }}
<% endfor %>
<% endif %>
        working-directory: <{ lang_subdir }>
        run: |
          set -a
          if [[ -f .env ]]; then
            source .env
          fi
          if [[ -f .env.${{ matrix.platform }} ]]; then
            source .env.${{ matrix.platform }}
          fi
          if [[ -f .env.ci ]]; then
            source .env.ci
          fi
          set +a

          if [[ -f ci/scripts/pre-test.sh ]]; then
            echo "Loading pre-test"
            ./ci/scripts/pre-test.sh ${{ matrix.platform }} ${{ matrix.arch }}
          fi

          docker ps
          pixi run validate

          if [[ -f ci/scripts/post-test.sh ]]; then
            ./ci/scripts/post-test.sh
          fi

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: validation-report
          path: "<{ lang_subdir }>/validation-report.xml"
          retention-days: 7

      - name: Generate docs
        working-directory: <{ lang_subdir }>
        run: |
          pixi run gendocs --output generated

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: docs
          path: "<{ lang_subdir }>/generated/<{driver}>.md"
          retention-days: 2
<% endif %>

  build:
    name: "Build <{driver}>/${{ matrix.platform }}_${{ matrix.arch }}"
    needs: test
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: true
      matrix:
        include:
          - { platform: linux, arch: amd64, runner: ubuntu-latest }
<% if private %>
          - { platform: linux, arch: arm64, runner: private-ubuntu-24.04-arm }
<% else %>
          - { platform: linux, arch: arm64, runner: ubuntu-24.04-arm }
<% endif %>
          - { platform: macos, arch: arm64, runner: macos-latest }
          - { platform: windows, arch: amd64, runner: windows-latest }
<% if environment %>
    environment: <{environment}>
<% endif %>
    permissions:
      contents: read
      packages: read

    steps:
<% if release or not secrets["all"] %>
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false
<% else %>
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        if: github.event_name != 'workflow_dispatch'
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: "checkout remote"
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        if: github.event_name == 'workflow_dispatch'
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.ref }}
          fetch-depth: 0
          persist-credentials: false
<% endif %>

<% if lang == "go" %>
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5  # v6.2.0
        with:
          cache-dependency-path: go/go.sum
          check-latest: true
          go-version-file: go/go.mod
<% elif lang == "rust" %>
      - uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c  # v1.15.2
        with:
          components: "clippy"
<% endif %>

      - uses: prefix-dev/setup-pixi@82d477f15f3a381dbcc8adc1206ce643fe110fb7  # v0.9.3
        with:
          pixi-version: v0.63.2
          run-install: false

      - name: Install dev tools
        working-directory: <{ lang_subdir }>
        run: |
          pixi install

      - name: Log in to ghcr.io
        if: runner.os == 'Linux'
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build Library
        working-directory: <{ lang_subdir }>
<% if secrets["build:release"] %>
        env:
<% for name, val in secrets["build:release"].items() %>
          <{name}>: ${{ secrets.<{val}> }}
<% endfor %>
<% endif %>
        run: |
          if [[ -f ci/scripts/pre-build.sh ]]; then
            ./ci/scripts/pre-build.sh release ${{ matrix.platform }} ${{ matrix.arch }}
          fi
          set -a
          if [[ -f .env.release ]]; then
            source .env.release
          fi
          set +a
          pixi run adbc-make check CI=true VERBOSE=true DRIVER=<{driver}> IMPL_LANG=<{lang}> <{' '.join(lang_config.build.additional_make_args) }>

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: drivers-${{ matrix.platform }}-${{ matrix.arch }}
          path: "<{ lang_subdir }>/build/libadbc_driver_<{driver}>.*"
          retention-days: 2

  package:
    name: "Generate Packages"
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read

    steps:
<% if release or not secrets["all"] %>
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false
<% else %>
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        if: github.event_name != 'workflow_dispatch'
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: "checkout remote"
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        if: github.event_name == 'workflow_dispatch'
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.ref }}
          fetch-depth: 0
          persist-credentials: false
<% endif %>

<% if lang == "go" %>
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5  # v6.2.0
        with:
          check-latest: true
          go-version: "stable"
<% elif lang == "rust" %>
      - uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c  # v1.15.2
        with:
          components: "clippy"
<% endif %>

      - uses: prefix-dev/setup-pixi@82d477f15f3a381dbcc8adc1206ce643fe110fb7  # v0.9.3
        with:
          pixi-version: v0.63.2
          run-install: false

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7.0.0
        with:
          pattern: "drivers-*"
          path: "~/drivers"

      - name: Install tools
        working-directory: <{ lang_subdir }>
        run: |
<% if lang == "go" %>
          # XXX: can't install go-licenses under go 1.25
          # https://github.com/google/go-licenses/issues/312
          git clone --depth=1 https://github.com/google/go-licenses
          git config --global --add 'url.https://github.com/.insteadOf' ssh://git@github.com/
          pushd go-licenses
          go get -u
          # Silent break: https://github.com/spf13/cobra/pull/2303
          # Manually edit the go.mod to get around this for now
          sed -i 's|github.com/spf13/pflag v1.0.8|github.com/spf13/pflag v1.0.7|g' go.mod
          go mod tidy
          go install .
          popd
<% elif lang == "rust" %>
          cargo install cargo-about
<% endif %>

      - name: Generate packages
        working-directory: <{ lang_subdir }>
        run: |
          pixi install

          pixi run adbc-gen-package \
            --name <{driver}> \
            --root $(pwd) \
            --manifest-template $(pwd)/manifest.toml \
            ${{ (inputs.release && '--release') || '' }}\
            -o ~/packages \
            ~/drivers/drivers-*-*/

          ls ~/packages

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: all-packages
          path: ~/packages
          retention-days: 7

  test-packages:
    name: "Test Packages/${{ matrix.platform }}_${{ matrix.arch }}"
    runs-on: ${{ matrix.runner }}
    needs:
      - package
    strategy:
      fail-fast: false
      matrix:
        include:
          - { platform: linux, arch: amd64, runner: ubuntu-latest }
          - { platform: macos, arch: arm64, runner: macos-latest }
          - { platform: windows, arch: amd64, runner: windows-latest }
<% if environment %>
    environment: <{environment}>
<% endif %>
    steps:
      # for now, install dbc from main
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5  # v6.2.0
        with:
          go-version: 'stable'
      - uses: prefix-dev/setup-pixi@82d477f15f3a381dbcc8adc1206ce643fe110fb7  # v0.9.3
        with:
          pixi-version: v0.63.2
          run-install: false
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7.0.0
        with:
          name: "all-packages"
          path: "~/packages"
      - name: install package
        # dbc uses the filename as the driver name
        run: |
          echo "Installing dbc"
          git clone --depth 1 https://github.com/columnar-tech/dbc
          cd dbc
          go build ./cmd/dbc
          echo "Installed dbc"
          driver_pkg=$(find ~/packages -name '*_${{ matrix.platform }}_${{ matrix.arch }}_*.tar.gz')
          ./dbc install --no-verify "${driver_pkg}"
          echo "Installed ${driver_pkg}"
<% if release or not secrets["all"] %>
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 1
          persist-credentials: false
<% else %>
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        if: github.event_name != 'workflow_dispatch'
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: "checkout remote"
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        if: github.event_name == 'workflow_dispatch'
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.ref }}
          fetch-depth: 1
          persist-credentials: false
<% endif %>
      - name: load package
<% if private or secrets["build:test"] %>
        env:
<% if private %>
          COLUMNAR_CLOUD_API_TOKEN: ${{ secrets.COLUMNAR_CLOUD_API_TOKEN }}
<% endif %>
<% if secrets["build:test"] %>
<% for name, val in secrets["build:test"].items() %>
          <{name}>: ${{ secrets.<{val}> }}
<% endfor %>
<% endif %>
<% endif %>
        working-directory: <{ lang_subdir }>
        run: |
          if [[ -f ci/scripts/pre-build.sh ]]; then
            echo "Loading pre-build"
            ./ci/scripts/pre-build.sh test ${{ matrix.platform }} ${{ matrix.arch }}
          fi

          if [[ -f .env.ci ]]; then
            source .env.ci
          fi
<% if private %>
          export COLUMNAR_DRIVER_LICENSE_KEY=$(curl --silent --fail -XGET -H 'Content-Type: application/json' -H "Authorization: Bearer $COLUMNAR_CLOUD_API_TOKEN" https://heimdall.columnar.tech/trial_license)
<% endif %>
          pixi exec -s adbc-driver-manager -s pyarrow -s pytest python -m pytest -vs ci/test_package.py

  release:
<% if release %>
    name: "Release"
<% else %>
    name: "Release (Dry Run)"
<% endif %>
    runs-on: ubuntu-latest
    needs:
      - package
      - test-packages
<% if not lang_config.skip_validate %>
      - validate
<% endif %>
    permissions:
<% if release %>
      contents: write
<% else %>
      contents: read
<% endif %>

    steps:
<% if release or not secrets["all"] %>
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false
<% else %>
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        if: github.event_name != 'workflow_dispatch'
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: "checkout remote"
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        if: github.event_name == 'workflow_dispatch'
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.ref }}
          fetch-depth: 0
          persist-credentials: false
<% endif %>

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5  # v6.2.0
        with:
          check-latest: true
          go-version: "stable"

      - uses: prefix-dev/setup-pixi@82d477f15f3a381dbcc8adc1206ce643fe110fb7  # v0.9.3
        with:
          pixi-version: v0.63.2
          run-install: false

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7.0.0
        with:
          name: "all-packages"
          path: "~/packages"

<% if not lang_config.skip_validate %>
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7.0.0
        with:
          name: "docs"
          path: "~/packages"
<% endif %>

<% if release %>
      - name: Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        working-directory: <{ lang_subdir }>
        run: |
          ref=${{ github.ref }}
          tag=${ref#"refs/tags/"}
<% if lang == "rust" %>
          declared_version=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].version')
          if [[ "${declared_version}" != "${tag#*v}" ]];
             echo "Declared driver version in Cargo.toml ${declared_version}"
             echo "does not match tag ${tag#*v}"
             echo "Please update the version before release."
             exit 1
          fi
<% endif %>
          pixi run release $(pwd) $tag
          gh release upload $tag $(find ~/packages -name '*.tar.gz') $(find ~/packages -name 'manifest.yaml') $(find ~/packages -name '*.md')

      - name: Release (dry-run)
        if: github.event_name != 'push' || !startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        working-directory: <{ lang_subdir }>
        run: |
          git tag go/v1000.0.0
          tag=go/v1000.0.0

          pixi run release --dry-run $(pwd) $tag
          echo gh release upload $tag $(find ~/packages -name '*.tar.gz') $(find ~/packages -name 'manifest.yaml') $(find ~/packages -name '*.md')
<% else %>
      - name: Release (dry-run)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        working-directory: <{ lang_subdir }>
        run: |
          git tag <{ lang_subdir }>/v1000.0.0
          tag=<{ lang_subdir }>/v1000.0.0

          pixi run release --dry-run $(pwd) $tag
          echo gh release upload $tag $(find ~/packages -name '*.tar.gz') $(find ~/packages -name 'manifest.yaml') $(find ~/packages -name '*.md')
<% endif %>
